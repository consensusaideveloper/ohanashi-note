# Ohanashi Note (おはなしノート)

A voice conversation web app that helps elderly Japanese users (60-80 years old) create ending notes through natural dialogue with an AI assistant.

## Tech Stack

- **Client**: React 19, Vite, Tailwind CSS v4, Firebase Auth
- **Server**: Hono, Node.js, PostgreSQL (Railway), Drizzle ORM
- **AI**: OpenAI Realtime API (voice relay via WebSocket)
- **Auth**: Firebase Authentication (Google sign-in)
- **Infra**: Railway (server + DB), Cloudflare R2 (media storage)

## Project Structure

```
app/
  client/          # React + Vite frontend
    src/
      components/  # UI components
      contexts/    # React contexts (auth, font size)
      hooks/       # Custom hooks (conversation, audio, auth)
      lib/         # Utilities, constants, Firebase config
      types/       # TypeScript type definitions
  server/          # Hono + Node.js backend
    src/
      db/          # Drizzle schema + migrations
      lib/         # Config, logger, Firebase Admin
      middleware/   # Auth middleware
      routes/      # API + WebSocket routes
      services/    # OpenAI relay, sanitizer, summarizer
  e2e/             # Playwright end-to-end tests
docs/              # Research and planning documents
```

## Prerequisites

- Node.js >= 20
- npm >= 10
- PostgreSQL database (Railway recommended)
- Firebase project with Authentication enabled
- OpenAI API key with Realtime API access

## Setup

1. Clone the repository:

   ```bash
   git clone https://github.com/consensusaideveloper/ohanashi-note.git
   cd ohanashi-note
   ```

2. Install dependencies:

   ```bash
   cd app
   npm install
   ```

3. Configure environment variables:

   ```bash
   cp .env.example .env
   # Fill in your API keys and credentials
   ```

4. Run database migrations:

   ```bash
   cd server
   npx drizzle-kit push
   ```

5. Start development servers:
   ```bash
   cd app
   npm run dev
   ```
   This starts both the client (http://localhost:5173) and server (http://localhost:3000).

## Scripts

All scripts are run from the `app/` directory:

| Command             | Description                        |
| ------------------- | ---------------------------------- |
| `npm run dev`       | Start client + server in dev mode  |
| `npm run build`     | Production build (client + server) |
| `npm run lint`      | Run ESLint                         |
| `npm run typecheck` | TypeScript type checking           |
| `npm run test`      | Run all tests (Vitest)             |
| `npm run format`    | Format with Prettier               |

## サービス利用ガイド

### サービス概要

おはなしノートは、**AIとの音声会話を通じてエンディングノートを作成する**Webアプリケーションです。

- **対象ユーザー**: 60〜80歳の高齢者
- **基本コンセプト**: 難しい入力操作は不要。声で話すだけで、AIが内容を整理してノートに記録します
- **AIキャラクター**: 3人の個性あるキャラクターが話し相手として寄り添います
- **11カテゴリ・110問**: 思い出から法律・制度まで、人生のあらゆる側面をカバーします

---

### 利用の流れ

```
1. Googleアカウントでログイン
2. 利用規約・プライバシーポリシーに同意
3. 初期設定（AIとの音声会話でお名前・キャラクター・文字サイズ・話し方を設定）
4. メイン画面でAIと会話しながらノートを作成
```

**家族として招待された場合:**

```
1. 招待リンクを開く
2. Googleアカウントでログイン
3. 招待を承認（続柄を確認）
4. 家族画面からノート作成者の情報にアクセス
```

---

### 画面構成と機能

アプリは下部ナビゲーションバーの5つのタブで構成されています。

#### 1. 会話画面（メイン画面）

AIと音声で会話し、エンディングノートの内容を記録する画面です。

- **テーマ選択モード**: 11カテゴリから話したいテーマを選んで会話を開始
- **おまかせモード**: AIが未回答の項目から自動的にテーマを選び、カテゴリを横断して会話をリード
- **AIアバター**: 会話中にAIの表情がアニメーションで変化します
- **会話の操作**: マイクボタンで会話を開始・停止。会話終了時にAIが内容を自動で要約・記録
- **1日のセッション制限**: 1日3回まで、1回20分まで（コスト分析に基づく設定。詳細は `docs/cost-analysis.md`）

**会話中にAIができること（音声操作）:**

| 操作                       | 声のかけ方の例                     |
| -------------------------- | ---------------------------------- |
| 画面の移動                 | 「ノートを見せて」「設定を開いて」 |
| ノートの特定カテゴリを表示 | 「思い出の記録を見せて」           |
| 文字の大きさを変更         | 「文字を大きくして」               |
| 話し相手を変更             | 「話し相手を変えたい」             |
| 名前の変更                 | 「〇〇と呼んで」                   |
| 話し方の変更               | 「もっとゆっくり話して」           |
| 新しいテーマで会話開始     | 「お金のことで話したい」           |
| 家族の招待                 | 「妻を招待して」                   |
| 開封設定の変更             | 「この話は息子に見せて」           |
| 会話の終了                 | 「今日はここまで」「おやすみ」     |

#### 2. 履歴画面

過去の会話を振り返る画面です。

- 会話の一覧表示（日時、テーマ、要約）
- 会話の詳細表示（発言のやりとり全文、AI要約、キーポイント）
- 録音された音声の再生
- カテゴリや期間でフィルタリング

#### 3. ノート画面

AIとの会話から抽出された情報が、カテゴリ別に整理されて表示される画面です。

- 11カテゴリごとの記録内容を閲覧
- 各カテゴリの回答済み/未回答の進捗を確認
- 開封設定（家族ごとにどのカテゴリを見せるか）の確認・管理

#### 4. 設定画面

アプリの各種設定を変更する画面です。

| 設定項目             | 説明                                             |
| -------------------- | ------------------------------------------------ |
| 話し相手キャラクター | 3人のキャラクターから選択                        |
| 文字の大きさ         | 標準・大きめ・特大の3段階                        |
| 話す速さ             | ゆっくり・ふつう・はやめの3段階                  |
| 待ち時間             | AIが返答を待つ時間（短め・ふつう・長め）         |
| 確認の頻度           | AIが理解を確認する頻度（こまめ・ふつう・少なめ） |
| ノートの印刷         | エンディングノート全体をPDF形式で印刷            |
| データのエクスポート | ノートデータをJSONファイルとして書き出し         |
| データのインポート   | JSONファイルからノートデータを読み込み           |
| アカウント管理       | ログアウト、データ削除                           |

#### 5. 家族画面

家族の招待と管理、ノートのライフサイクルを管理する画面です。2つのタブに分かれています。

**「わたしの家族」タブ（ノート作成者向け）:**

自分のノートに関わる家族を管理するタブです。

- **家族の招待**: 招待リンクを作成して家族にLINEやメールで共有。続柄（配偶者、子、兄弟など）を指定
- **家族メンバーの管理**: 登録済み家族の一覧表示、続柄の編集、メンバーの削除
- **代表者の設定**: 家族メンバーの中から「代表者」を指定（最大2名）。代表者はノートのライフサイクル操作（逝去報告、同意収集の開始など）を行える
- **開封設定**: 自分のノートのどのカテゴリを、どの家族メンバーに見せるかを事前に設定。この設定はノート開封時にアクセス権の推奨値として使用される

**「家族のノート」タブ（家族メンバー向け）:**

自分が家族として登録されているノート作成者の一覧を表示するタブです。

- **作成者一覧**: 自分が家族として登録されているノート作成者をカード形式で表示。各カードにライフサイクルの状態と対応待ちのバッジが表示される
- **作成者詳細画面**: カードをタップすると詳細画面に遷移し、ライフサイクルの状態に応じた操作が可能：

| ライフサイクル状態 | 表示される操作                                           |
| ------------------ | -------------------------------------------------------- |
| 通常利用中         | 逝去報告ボタン（代表者のみ）                             |
| 逝去報告済み       | 同意収集の開始、逝去報告の取り消し（代表者のみ）         |
| 同意収集中         | 同意・不同意の選択、同意の進捗確認（代表者のみ）         |
| 開封済み           | ノートを見る、やることリスト、アクセス管理（代表者のみ） |

**ノート閲覧画面（開封後）:**

ノートが開封された後、家族メンバーが閲覧できる画面です。

- 開封設定に基づき、許可されたカテゴリのみ表示
- カテゴリごとの記録内容、進捗の確認
- ノートの印刷

**やることリスト（Todo）:**

ノート開封後に家族間でタスクを管理する機能です。

- タスクの手動作成、またはAIが会話内容から自動生成
- ステータス管理（未着手・対応中・完了）
- 家族メンバーへの割り当て
- 優先度（高・中・低）と期限の設定
- コメント機能で家族間の相談
- ステータスでフィルタリング

**アクセス管理画面（代表者のみ）:**

ノート開封後に、各家族メンバーがどのカテゴリを閲覧できるかを管理する画面です。

- 家族メンバー × カテゴリのマトリクス形式でアクセス権を管理
- カテゴリごとにアクセスの付与・取り消し
- 作成者が生前に設定した「開封設定」を推奨値として表示

**通知機能:**

- 画面右上のベルアイコンで未読通知を確認
- 家族招待の承認、ライフサイクルの変更、同意リクエストなどを通知
- 個別・一括での既読処理

---

### AIキャラクター

3人のキャラクターから、自分に合った話し相手を選べます。

| キャラクター | 性格             | 話し方の特徴                                                                      |
| ------------ | ---------------- | --------------------------------------------------------------------------------- |
| **のんびり** | 穏やかでゆったり | 「へえ〜、それは素敵ですね〜」「全然急がなくていいので」など、安心感のある語り口  |
| **しっかり** | 落ち着いて頼れる | 「なるほど、そういうことですね」「ポイントを整理すると...」など、わかりやすく整理 |
| **にこにこ** | 明るく楽しい     | 「えっ、すごい！」「いいね〜！」など、リアクション豊かで元気をもらえる            |

---

### エンディングノートの質問項目一覧

AIが会話の中で自然に聞いていく質問の全リストです。すべてを一度に聞くのではなく、セッションごとに5問程度を目安に、ゆっくり進めます。

#### 思い出（6問）

- 自分史・趣味・好きなもの
- 一番楽しかった家族旅行
- 子が生まれた日
- やりたいことリスト
- 若い頃のエピソード
- 働き盛りの頃の思い出（壮年期）

#### 大事な人・ペット（10問）

- 大事な人
- 家族へのメッセージ
- 一人ひとりへのメッセージ
- もしもの時に頼りたい人
- 緊急連絡先
- 親族・友人の連絡先
- ペットの情報
- ペットの引き取り
- ペットの病歴・アレルギー
- ペットの特徴と見分け方

#### 生活（5問）

- 家の管理
- 貴重品・コレクション
- 誰かに譲りたいもの（形見分け）
- 携帯電話・通信契約
- 内密に処分してほしいもの

#### 医療・介護（13問）

- 常用の薬
- かかりつけの病院
- アレルギー
- 病歴
- 保険証・マイナンバー
- 介護の希望
- もしもの備え・財産の管理
- 延命治療の希望
- 臓器提供の意思
- 基本情報の保管
- 延命治療の書類（尊厳死宣言書）
- 終末期の過ごし方
- かかりつけ医との相談

#### 葬儀・供養（11問）

- 葬儀の希望
- 宗教・菩提寺
- お墓の準備
- 埋葬の方法
- 遺影の写真
- 訃報を伝える人
- 葬儀に呼ぶ人・呼ばない人
- 仏壇・神棚の管理
- 墓じまいの検討
- 永代供養の希望
- 散骨の希望

#### お金・資産（18問）

- メインの銀行
- その他の銀行口座
- 通帳と印鑑の場所
- 株や投資のこと（有価証券）
- 生命保険
- ローンの有無
- 不動産の権利証
- 年金と受給状況
- クレジットカード
- 個人間の貸し借り
- ポイント・電子マネー
- その他の貴重品
- 利用中のサービス
- 定期契約の解約
- 相続の希望
- 実印の登録と保管
- 銀行届出印の使い分け
- 印鑑登録証の保管

#### 仕事・事業（9問）

- 現在のお仕事
- 勤務先・事業の連絡先
- 退職金・企業年金
- 取引先・お客様
- 事業の継続・廃業の希望
- 仕事の免許や契約書（許認可）
- 事業用の借入・保証
- 顧問の専門家
- 自分の作品や特許（知的財産）

#### スマホ・ネット（7問）

- 仮想通貨（ネット上のお金）
- ネット証券・つみたてNISA
- パスワードメモの場所
- SNSの死後対応
- 写真データの整理
- 亡くなった後のアカウント管理（追悼アカウント）
- 声や姿を残すこと

#### 財産と遺言（12問）

> このカテゴリの記録は法的効力を持ちません。具体的な手続きは専門家（弁護士・司法書士等）にご相談ください。

- ご家族の構成（法定相続人）
- 財産の整理（相続財産）
- 遺言書の種類と保管
- 遺言を届ける人
- 生きているうちに渡したい財産（生前贈与）
- 生命保険の活用
- 税金がかからない仕組みの活用
- 土地や家の名義変更（相続登記）
- 財産の分け方の希望（遺産分割）
- 寄付のご希望
- 借金の引き継ぎについて
- 養子縁組の意向

#### 将来の備え（11問）

> このカテゴリの記録は法的効力を持ちません。具体的な手続きは専門家（弁護士・司法書士等）にご相談ください。

- 家族信託の検討
- 財産を預ける人・預かる人（家族信託）
- 空き家対策
- ペット信託
- 亡くなった後の手続きを頼む人（死後事務委任）
- 判断が難しくなった時の備え（任意後見）
- 後見人になってほしい人（任意後見受任者）
- 身元保証人
- 見守り契約
- 親なき後の備え
- 信頼できる専門家

#### 使える制度（8問）

> 制度の詳細や申請方法は、お住まいの市区町村窓口や社会福祉協議会にご確認ください。

- 判断が難しくなったときの支援
- 生活保護の相談
- 葬儀費用の補助金
- 自宅を使った生活資金の仕組み
- 自宅を売って住み続ける方法
- 遺族年金の確認
- 暮らしの手助けサービス（日常生活自立支援）
- 介護保険の利用状況

---

### ノートのライフサイクル

エンディングノートは、以下のライフサイクルで管理されます。

```
通常利用中（active）
  ↓  家族が逝去を報告
逝去報告済み（death_reported）
  ↓  家族全員に同意を依頼
同意待ち（awaiting_consent）
  ↓  必要な家族が同意
開封済み（open）
  ↓  開封設定に基づき家族がノートを閲覧可能
  ↓  （希望に応じて）
削除（deleted）
```

- **通常利用中**: 本人がAIと会話しながらノートを作成・更新する段階
- **逝去報告**: 家族メンバーが家族画面から逝去を報告する操作
- **同意待ち**: 登録されている家族メンバー全員に開封への同意を依頼
- **開封済み**: 本人が生前に設定した「開封設定」に基づき、各家族メンバーが許可されたカテゴリのノート内容を閲覧可能
- **削除**: 家族メンバーの同意のもと、ノートデータを完全削除

---

### セキュリティとプライバシー

- **機密情報の保護**: AIはパスワード・暗証番号・カード番号・口座番号を絶対に聞きません。会社名やサービス名のレベルまでしか確認しません
- **入力防止ガード**: ユーザーが機密情報を話そうとした場合、AIがやんわりと止めます
- **開封設定**: 本人が生前に「どの家族に・どのカテゴリを見せるか」を設定できます
- **アクセス制御**: 家族は本人の逝去後、同意プロセスを経て初めてノートの内容にアクセスできます
- **法的免責**: 「財産と遺言」「将来の備え」カテゴリには、法的効力がないことの注意書きが表示されます

### データ保持方針

エンディングノートサービスでは「大切な記録を残すこと」が本質的な価値です。

- **ユーザーデータは自動削除しない**: 音声、会話テキスト、要約など、ユーザーに見えるデータはすべてユーザーが明示的に削除するまで保持します
- **コスト管理は料金プランで行う**: データの自動削除ではなく、プランごとのストレージ上限で制御します
- **内部中間データのみ自動クリーンアップ**: ユーザーに見えない処理用の中間データ（`improvedTranscript`）のみ、要約完了後に自動クリーンアップします
- **削除はユーザーの意思で**: 個別会話の削除、アカウント全削除はユーザーがいつでも実行可能です

---

## Documentation

Research and design documents are in the [`docs/`](docs/) directory:

- [Cost Analysis](docs/cost-analysis.md) — API/インフラコスト分析、料金プラン設計、データ保持ポリシー
- [Voice Automation Spec](docs/voice-automation-spec.md) — 音声操作（AIファンクションコール）の仕様
- [Family Lifecycle Spec](docs/family-lifecycle-spec.md) — ノートのライフサイクルと家族アクセスの仕様
- [MVP Tech Decisions](docs/mvp-tech-decisions.md)
- [Data Storage Architecture](docs/data-storage-architecture.md)
- [Realtime API MVP Plan](docs/realtime-api-mvp-plan.md)
- [Realtime UX Design](docs/realtime-ux-design.md)
- [Implementation Schedule](docs/implementation-schedule.md)

## License

Private repository. All rights reserved.
