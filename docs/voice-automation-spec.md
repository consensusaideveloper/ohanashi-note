# 音声AI操作 機能仕様書

## 概要

AIとの音声会話中に、声だけでアプリの操作を行える仕組み。
OpenAI Realtime API の function calling を利用し、ユーザーの発話意図をAIが解釈して適切なツールを呼び出す。

**対象ユーザー**: 高齢者（60-80歳）
**ブランチ**: `feature/voice-automation`

---

## アーキテクチャ

```
ユーザー「ノートを見せて」
  → マイク → OpenAI Realtime API
  → AIがfunction_callを判定: navigate_to_screen({screen: "note"})
  → useConversation.handleFunctionCall
  → dispatchVoiceAction → VoiceActionContext経由でApp.tsxのコールバック実行
  → setScreen("note") → 画面遷移
  → 結果をAIに返却 → AI「ノートの画面に移動しました」と読み上げ
```

### 主要コンポーネント

| ファイル | 役割 |
|---------|------|
| `contexts/VoiceActionContext.tsx` | アクションコールバックのRefを保持するContext |
| `hooks/useConversation.ts` | OpenAI接続・function call処理（AppContentレベルで呼び出し） |
| `App.tsx` | コールバックの実装を登録、確認ダイアログ管理 |
| `lib/constants.ts` | REALTIME_TOOLS定義（全13ツール） |
| `lib/prompt-builder.ts` | AIへの指示プロンプト（ツール使用ルール含む） |
| `components/ActiveConversationBanner.tsx` | 他画面での「会話中」バナー表示 |

### useConversationのリフトアップ

`useConversation` は `ConversationScreen` 内ではなく `AppContent` レベルで呼び出される。
これにより、会話中に他のタブに音声で移動しても **WebSocket接続と音声が途切れない**。

- 他タブ上では `ActiveConversationBanner`（「のんびりとお話し中です — タップで戻る」）が表示される
- 会話画面に戻ればそのまま会話を継続できる

---

## 安全性ティアモデル

すべての音声操作を4段階の安全レベルに分類している。

### Tier 0: 読み取り・閲覧系（自動実行、確認不要）

データ変更なし。リスクゼロ。AIが即座に実行し、結果を口頭で伝える。

| # | ツール名 | 説明 | 発話例 |
|---|---------|------|--------|
| 1 | `search_past_conversations` | 過去の会話をキーワード検索 | 「前に旅行の話したよね？」 |
| 2 | `get_note_entries` | 記録済みノート内容を取得 | 「思い出に何を記録した？」 |
| 3 | `navigate_to_screen` | 画面を切り替え | 「ノートを見せて」「設定を開いて」 |
| 4 | `view_note_category` | ノートの特定カテゴリを表示 | 「医療の記録を見せて」 |
| 5 | `filter_conversation_history` | 履歴画面を表示 | 「前の会話を見せて」 |

#### navigate_to_screen 移動先

| パラメータ値 | 移動先画面 | 日本語ラベル |
|-------------|-----------|-------------|
| `conversation` | 会話画面 | 会話 |
| `note` | エンディングノート | ノート |
| `history` | 会話履歴 | 履歴 |
| `settings` | 設定画面 | 設定 |
| `family` | 家族ダッシュボード | 家族 |

#### view_note_category カテゴリ一覧

| カテゴリID | 日本語名 |
|-----------|---------|
| `memories` | 思い出 |
| `people` | 大事な人・ペット |
| `house` | 生活 |
| `medical` | 医療・介護 |
| `funeral` | 葬儀・供養 |
| `money` | お金・資産 |
| `work` | 仕事・事業 |
| `digital` | デジタル |
| `legal` | 相続・遺言 |
| `trust` | 信託・委任 |
| `support` | 支援制度 |

#### search_past_conversations パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `query` | string | はい | 検索キーワード |
| `category` | string | いいえ | カテゴリで絞り込み |

#### filter_conversation_history パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `category` | string | いいえ | カテゴリで絞り込み |

---

### Tier 1: 可逆設定変更（自動実行、AI口頭確認）

設定変更だが簡単に元に戻せる。AIが即座に実行し、変更結果を口頭で確認する。

| # | ツール名 | 説明 | 発話例 | AIの応答例 |
|---|---------|------|--------|-----------|
| 6 | `change_font_size` | 文字サイズ変更 | 「文字を大きくして」 | 「文字を大きめに変更しました、見やすくなりましたか？」 |
| 7 | `change_character` | キャラクター変更 | 「話し相手を変えたい」 | 「次回の会話からのんびりがお相手します」 |
| 8 | `update_user_name` | 表示名変更 | 「太郎と呼んで」 | 「お名前を太郎に変更しました」 |
| 9 | `update_speaking_preferences` | 話し方設定変更 | 「もっとゆっくり話して」 | 「話す速さをゆっくりに変更しました」 |
| 10 | `update_access_preset` | 開封設定変更 | 「医療のことは妻に見せて」 | 「花子さんに医療・介護を見せる設定にしました」 |

#### change_font_size パラメータ

| パラメータ | 型 | 必須 | 値 | 日本語ラベル |
|-----------|------|------|-----|-------------|
| `level` | string | はい | `standard` | 標準 |
| | | | `large` | 大きめ |
| | | | `x-large` | 特大 |

#### change_character パラメータ

| パラメータ | 型 | 必須 | 値 | 説明 |
|-----------|------|------|-----|------|
| `character_name` | string | はい | `のんびり` | 穏やかな話し相手（voice: shimmer） |
| | | | `しっかり` | 頼れる相談相手（voice: echo） |
| | | | `にこにこ` | 明るい話し相手（voice: nova） |

**注意**: キャラクター変更は **次回の会話から適用** される（現在の会話のAI音声は変わらない）。プロフィールに保存され、次回 `start()` 時に新キャラクターが使われる。

#### update_user_name パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `name` | string | はい | 新しい名前（空文字はエラー） |

#### update_speaking_preferences パラメータ

すべてのパラメータはオプション。指定されたフィールドのみ更新される。

| パラメータ | 型 | 必須 | 値 | 説明 |
|-----------|------|------|-----|------|
| `speaking_speed` | string | いいえ | `slow` | ゆっくり（一文15字以内、一度に一つの情報） |
| | | | `normal` | ふつう（デフォルト） |
| | | | `fast` | テンポよく（要点を簡潔に） |
| `silence_duration` | string | いいえ | `short` | 短め（VAD 800ms — すぐ応答） |
| | | | `normal` | ふつう（VAD 1200ms — デフォルト） |
| | | | `long` | 長め（VAD 2000ms — ゆっくり待つ） |
| `confirmation_level` | string | いいえ | `frequent` | 多め（復唱・要約確認あり） |
| | | | `normal` | ふつう（デフォルト） |
| | | | `minimal` | 少なめ（確認最小限） |

**動作**: 設定変更はプロフィールに永続化され、現在の会話セッションにも即時反映される（`session.update` 再送信による prompt + VAD 更新）。

#### update_access_preset パラメータ

| パラメータ | 型 | 必須 | 値 | 説明 |
|-----------|------|------|-----|------|
| `family_member_name` | string | はい | 任意テキスト | 家族メンバーの名前または関係名（例：「太郎」「妻」） |
| `category` | string | はい | カテゴリID | 対象カテゴリ（view_note_categoryと同じカテゴリ一覧） |
| `action` | string | はい | `grant` | 見せる設定を追加 |
| | | | `revoke` | 見せる設定を削除 |

**動作**: 開封設定（accessPresets）をサーバーに永続化。会話開始時に家族メンバー一覧と現在のプリセット状態がAIのシステムプロンプトに注入される。家族未登録の場合はプロンプトに情報が含まれないため、AIがこの機能に言及することはない。

**名前解決**: AIは名前（「太郎」）または関係名（「妻」）で指定し、コールバック内で `FamilyMember.name` と `FamilyMember.relationshipLabel` の両方でマッチングを行う。一致しない場合はエラーメッセージを返却し、AIが再確認する。

**AI行動ルール**:
- カテゴリの会話がひと区切りついた時のみ、自然に「この内容はご家族に見てもらいたいですか？」と聞く
- 1回の会話で最大2回まで。しつこくしない
- ユーザーが曖昧な回答をした場合はツールを呼ばず、明確な意思表示がある場合のみ実行
- 「みんなに見せて」は確認後、メンバーごとに順次ツールを呼び出す

---

### Tier 2: 重要操作（UI確認ダイアログ必須）

影響が大きい操作。AIが確認ダイアログを表示し、**タッチでの「はい」が必須**。
声での「はい」は誤発動リスクがあるため、タッチ確認を必須としている。

| # | ツール名 | 説明 | 発話例 |
|---|---------|------|--------|
| 11 | `start_focused_conversation` | テーマ指定で新しい会話開始 | 「お金のことで話したい」 |
| 12 | `create_family_invitation` | 家族招待リンク作成 | 「妻を招待して」 |

#### 確認フロー

```
ユーザー「お金のことで話したい」
  → AI: start_focused_conversation({category: "money"})
  → 確認ダイアログ表示: 「お金・資産のテーマで新しい会話を始めますか？現在の会話は保存されます。」
  → AI: 「確認画面を表示しました。よろしければ画面の『はい』を押してください」
  → ユーザーがタッチで「はい」→ 現在の会話停止 → 新しい会話開始
  → ユーザーがタッチで「キャンセル」→ 何も起こらない、会話続行
```

#### start_focused_conversation パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `category` | string | はい | 会話テーマ（view_note_categoryと同じカテゴリ一覧） |

#### create_family_invitation パラメータ

| パラメータ | 型 | 必須 | 値 | 説明 |
|-----------|------|------|-----|------|
| `relationship` | string | はい | `spouse` | 配偶者 |
| | | | `child` | 子 |
| | | | `sibling` | 兄弟姉妹 |
| | | | `grandchild` | 孫 |
| | | | `other` | その他 |
| `relationship_label` | string | はい | 任意テキスト | 表示用の関係名（例：「妻」「長男」） |

---

### Tier 3: 禁止操作（ツール化しない）

声だけでは危険すぎる操作。AIは実行せず、該当画面への移動を提案する。

| 操作 | 禁止理由 | AIの応答 |
|------|---------|---------|
| データ全削除 | 不可逆 | 「削除は設定画面から行えます。設定画面に移動しましょうか？」 |
| 会話記録・ノートの個別削除 | 不可逆 | 「削除は設定画面から行えます。設定画面に移動しましょうか？」 |
| 家族メンバー削除 | 社会的影響大 | 「家族の管理は家族画面から行えます。家族画面に移動しましょうか？」 |
| 逝去報告 | 重大すぎる | 「大切な手続きですので、家族画面から行ってください。家族画面に移動しましょうか？」 |
| 同意書提出 | 法的意味を持つ | 「同意の手続きは画面から行えます。該当画面に移動しましょうか？」 |
| データインポート | 上書きで不可逆 | 「データの管理は設定画面から行えます。設定画面に移動しましょうか？」 |
| データエクスポート | ファイル操作 | 「データの管理は設定画面から行えます。設定画面に移動しましょうか？」 |

ユーザーが画面移動に同意した場合は、`navigate_to_screen` で該当画面へ案内する。

---

### ライフサイクル操作

会話セッション自体の終了を制御するツール。

| # | ツール名 | 説明 | 発話例 |
|---|---------|------|--------|
| 13 | `end_conversation` | 会話を終了してデータを保存 | 直接的→即終了、間接的→確認後終了 |

#### end_conversation の動作

パラメータなし。AIが2段階の判断で終了意図を検出して呼び出す。

**2段階検出モデル:**

1. **直接的な終了意図 → 即座にend_conversationを呼ぶ**
   「終わりにしよう」「今日はここまで」「また今度」「さようなら」「バイバイ」など明確な意思表示。
   ```
   ユーザー: 「今日はここまでにしよう」
     → AI: end_conversation()
     → AI: 「今日もいいお話ができましたね。またいつでもどうぞ。」
     → 3秒後に会話自動停止 → データ保存・要約
   ```

2. **間接的な終了シグナル → 確認してからend_conversationを呼ぶ**
   「疲れちゃった」「ありがとうございました」「もうそろそろ」など示唆的な表現。
   ```
   ユーザー: 「疲れちゃったなぁ」
     → AI: 「お疲れでしたら、今日はこのへんにしましょうか？」
   ユーザー: 「うん、そうしよう」
     → AI: end_conversation()
     → AI: 「ゆっくりお休みくださいね。またお話ししましょう。」
     → 3秒後に会話自動停止 → データ保存・要約
   ```

   ユーザーが続行を希望した場合:
   ```
   ユーザー: 「ありがとうございました」
     → AI: 「今日はここまでにしましょうか？まだ話し足りないことがあれば続けますよ。」
   ユーザー: 「もう少し話したいかな」
     → AI: （会話を自然に続ける、end_conversationは呼ばない）
   ```

#### 終了意図の検出例

| 発話例 | 判定 | 検出方法 | 理由 |
|--------|------|----------|------|
| 「今日はここまでにしよう」 | 即終了 | クライアント + AI | 明示的な終了宣言 |
| 「また今度ね」 | 即終了 | クライアント + AI | 次回への先送り |
| 「さようなら」 | 即終了 | クライアント + AI | 別れの挨拶 |
| 「バイバイ」 | 即終了 | クライアント + AI | 別れの挨拶 |
| 「もう終わり」 | 即終了 | クライアント + AI | 明示的な終了宣言 |
| 「もういいです」 | 即終了 | クライアント + AI | 十分という意思表示 |
| 「疲れちゃった」 | 確認後終了 | クライアント + AI | 疲労（活用形も検出） |
| 「ありがとうございました」 | 確認後終了 | AIのみ | 感謝による締め（文脈判断） |
| 「もうそろそろ」 | 確認後終了 | AIのみ | 時間の区切り示唆 |
| 「お話しできてよかった」 | 確認後終了 | AIのみ | 満足感の表明 |
| 「疲れてきたけどもう少し話したい」 | 続行 | — | 疲労に言及しているが続行意思あり |
| 「この話は今日はここまでにして、次の話題に」 | 続行 | — | 話題の切り替えであって会話終了ではない |

#### barge-in によるキャンセル

AIのお別れ音声再生中にユーザーが割り込んで話した場合、終了フローはキャンセルされ会話が続行する。
これにより「あ、もう一つだけ聞きたい」といった状況に対応できる。

---

## AIの振る舞いルール

### ツール使用の基本方針

- ツールの存在をユーザーに説明しない（「ツールで操作できます」のような案内はNG）
- ユーザーの発話意図に応じて、AIが自然に判断してツールを呼び出す
- 操作後は簡潔に結果を口頭で伝える

### 話題変更 vs テーマ切り替え

- 会話中に「お金の話がしたい」と言われた場合 → **今の会話の中で柔軟に話題を変える**（ツール不使用）
- 明示的に「新しい会話を始めたい」「テーマを変えて」と言われた場合 → `start_focused_conversation` を使用

### 操作後の口頭確認パターン

| ティア | パターン | 例 |
|--------|---------|-----|
| Tier 0 | 結果を簡潔に伝える | 「ノートの画面に移動しました」 |
| Tier 1 | 結果 + 確認の問いかけ | 「文字を大きめに変更しました、見やすくなりましたか？」 |
| Tier 2 | 確認画面の誘導 | 「確認画面を出しました。よろしければ画面の『はい』を押してください」 |
| Tier 3 | 画面への案内提案 | 「削除は設定画面から行えます。設定画面に移動しましょうか？」 |

---

## シナリオ集

### シナリオ1: 画面ナビゲーション

```
ユーザー: 「ノートを見せて」
AI: navigate_to_screen({screen: "note"})
→ 画面がノートに切り替わる
→ 会話中バナー「のんびりとお話し中です — タップで戻る」が表示
AI: 「ノートの画面に移動しました」
```

### シナリオ2: ノートカテゴリ指定

```
ユーザー: 「思い出の記録を見せて」
AI: view_note_category({category: "memories"})
→ ノート画面に移動
AI: 「ノートの画面に移動しました。思い出の記録をご覧ください」
```

### シナリオ3: 文字サイズ変更

```
ユーザー: 「文字が小さくて見えないから大きくして」
AI: change_font_size({level: "large"})
→ アプリ全体のフォントサイズが変更
AI: 「文字を大きめに変更しました、見やすくなりましたか？」
```

### シナリオ4: キャラクター変更

```
ユーザー: 「もうちょっとしっかりした人と話したい」
AI: change_character({character_name: "しっかり"})
→ プロフィールに保存（次回会話から適用）
AI: 「次回の会話からしっかりがお相手します」
```

### シナリオ5: 名前変更

```
ユーザー: 「太郎って呼んでくれる？」
AI: update_user_name({name: "太郎"})
→ プロフィールに保存
AI: 「お名前を太郎に変更しました」
```

### シナリオ6: 話し方変更

```
ユーザー: 「もう少しゆっくり話してくれる？」
AI: update_speaking_preferences({speaking_speed: "slow"})
→ プロフィール保存 + 現セッションに即時反映（prompt + VAD更新）
AI: 「話す速さをゆっくりに変更しました。このペースでいいですか？」
```

```
ユーザー: 「返事をもう少し待ってほしい」
AI: update_speaking_preferences({silence_duration: "long"})
→ VAD silence_duration_ms が 2000ms に変更
AI: 「待ち時間を長めに変更しました。ゆっくりお考えくださいね」
```

### シナリオ7: 開封設定変更（音声で）

```
（医療テーマの会話が一区切りついた後）
AI: 「今お話しいただいた医療のことですが、ご家族に見てもらいたい方はいますか？」
ユーザー: 「妻の花子には見せたいけど、息子の太郎には見せなくていいかな」
AI: update_access_preset({family_member_name: "花子", category: "medical", action: "grant"})
→ サーバーに開封設定を保存
AI: 「花子さんに医療・介護を見せる設定にしました」
AI: update_access_preset({family_member_name: "太郎", category: "medical", action: "revoke"})
→ 既存設定を削除（設定がなければ何もしない）
AI: 「太郎さんには医療・介護を見せない設定にしました」
```

```
ユーザー: 「やっぱり思い出はみんなに見せたいな」
AI: 「全員に見せる設定にしますね」
AI: update_access_preset({family_member_name: "花子", category: "memories", action: "grant"})
AI: update_access_preset({family_member_name: "太郎", category: "memories", action: "grant"})
AI: 「花子さんと太郎さんに思い出を見せる設定にしました」
```

### シナリオ8: テーマ指定会話開始（確認あり）

```
ユーザー: 「お金のことで相談したいんだけど」
AI: start_focused_conversation({category: "money"})
→ 確認ダイアログ表示: 「お金・資産のテーマで新しい会話を始めますか？」
AI: 「確認画面を出しました。よろしければ画面の『はい』を押してください」
→ ユーザーが「はい」タップ → 現在の会話終了 → お金テーマの新規会話開始
```

### シナリオ9: 家族招待（確認あり）

```
ユーザー: 「妻を招待したい」
AI: create_family_invitation({relationship: "spouse", relationship_label: "妻"})
→ 確認ダイアログ表示: 「妻として家族を招待しますか？」
AI: 「確認画面を出しました。よろしければ画面の『はい』を押してください」
→ ユーザーが「はい」タップ → 招待リンク作成 → 家族ダッシュボードに移動
```

### シナリオ10: 禁止操作（画面案内）

```
ユーザー: 「全部消して」
AI: （ツール呼び出しなし）
AI: 「削除は大事な操作ですので、設定画面から行えます。設定画面に移動しましょうか？」
ユーザー: 「うん」
AI: navigate_to_screen({screen: "settings"})
AI: 「設定画面に移動しました」
```

### シナリオ11: 過去会話検索

```
ユーザー: 「前に旅行の話したよね？何て言ったか覚えてる？」
AI: search_past_conversations({query: "旅行"})
→ 過去の会話記録から旅行に関する内容を取得
AI: 「以前の会話で、北海道に旅行に行った思い出をお話しされていましたね。…」
```

### シナリオ12a: 会話終了（直接的な意図）

```
ユーザー: 「今日はここまでにしよう」
AI: end_conversation()
→ 結果: {success: true, message: "..."}
AI: 「今日もいいお話ができましたね。またいつでもどうぞ。」
→ 3秒後に会話自動停止、データ保存・要約開始
```

### シナリオ12b: 会話終了（間接的なシグナル → 確認 → 終了）

```
ユーザー: 「疲れちゃったなぁ」
AI: 「お疲れでしたら、今日はこのへんにしましょうか？」
ユーザー: 「うん、そうしよう」
AI: end_conversation()
→ 結果: {success: true, message: "..."}
AI: 「ゆっくりお休みくださいね。またお話ししましょう。」
→ 3秒後に会話自動停止、データ保存・要約開始
```

### シナリオ12c: 会話終了（間接的なシグナル → 確認 → 続行）

```
ユーザー: 「ありがとうございました」
AI: 「今日はここまでにしましょうか？まだ話し足りないことがあれば続けますよ。」
ユーザー: 「もう少し話したいかな」
AI: （会話を自然に続ける、end_conversationは呼ばない）
```

### シナリオ13: 話題変更（ツール不使用）

```
ユーザー: （医療テーマの会話中に）「お金のことも気になるんだけど」
AI: （ツール呼び出しなし — 会話内で対応）
AI: 「お金のことも気になりますよね。どんなことが心配ですか？」
```

---

## 技術的な制約・注意事項

### エラーハンドリング

- すべてのツール呼び出しは try/catch で囲まれている
- 同期ツール（Tier 0, Tier 1のchangeFontSize）はエラー時に `{error: "..."}`を返却
- 非同期ツール（changeCharacter, updateUserName, updateAccessPreset）はPromise.catchで `{error: "操作中にエラーが発生しました"}` を返却
- エラー時のメッセージはすべて日本語

### 画面ナビゲーション中のまとめ作成ガード

会話終了後のサマリー作成中（`isSummarizing === true`）に画面移動しようとすると、ConfirmDialogで確認が入る。
音声操作の `navigateWithGuard` も同じガードを通るため、まとめ中は移動前に確認ダイアログが表示される。

### セッション制限

- 1日最大5回の会話セッション
- 1セッション最大20分
- これらはサーバー側で強制（クライアント側はUX表示のみ）
- オンボーディング会話はセッション上限にカウントされない（下記参照）

### セキュリティ

- パスワード・暗証番号・カード番号・口座番号はAIが絶対に聞かない（プロンプトで制約）
- 機密情報を言いそうになったらAIがやんわり止める
- 全ツール呼び出しの結果は OpenAI に JSON で返却されるが、機密情報は含まれない

## オンボーディング会話フロー

新規ユーザー（`profile.name === ""`）に対して、フォーム入力ではなく音声会話でセットアップを行う。

### 使用ツール

| ツール | 用途 | Tier |
|--------|------|------|
| `update_user_name` | ユーザー名の設定 | Tier 1 |
| `change_character` | キャラクター選択 | Tier 1 |
| `change_font_size` | 文字サイズ選択 | Tier 1 |
| `update_speaking_preferences` | 話し方の好み設定 | Tier 1 |
| `end_conversation` | 全設定完了後の会話終了 | Lifecycle |

### フロー

1. のんびり（character-a, voice: shimmer）がデフォルトキャラクターとして自己紹介
2. お名前を聞いて `update_user_name` で設定
3. 3キャラクター（のんびり/しっかり/にこにこ）を紹介し選択 → `change_character` で設定
4. 文字サイズの好み（標準/大きめ/特大）を確認 → `change_font_size` で設定
5. 話し方の好み（速さ）を確認 → `update_speaking_preferences` で設定（オンボーディングでは速さのみ聞く）
6. `end_conversation` で会話終了 → メインアプリへ遷移

### セッション制限免除

- オンボーディング会話はデイリーセッション上限にカウントされない
- WebSocket接続時に `onboarding=true` クエリパラメータを付与
- サーバー側でユーザーの `name === ""` を検証し、正規のオンボーディングのみ免除

### 関連ファイル

- `client/src/hooks/useOnboardingConversation.ts` — オンボーディング専用会話フック
- `client/src/components/OnboardingConversation.tsx` — オンボーディングUI
- `client/src/lib/prompt-builder.ts` — `buildOnboardingPrompt()` 関数
- `client/src/lib/constants.ts` — `ONBOARDING_TOOLS`, `ONBOARDING_CONVERSATION_MESSAGES`
- `server/src/routes/ws.ts` — オンボーディング接続のセッション制限免除
