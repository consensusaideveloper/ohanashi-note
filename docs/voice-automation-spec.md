# 音声AI操作 機能仕様書

## 概要

AIとの音声会話中に、声だけでアプリの操作を行える仕組み。
OpenAI Realtime API の function calling を利用し、ユーザーの発話意図をAIが解釈して適切なツールを呼び出す。

**対象ユーザー**: 高齢者（60-80歳）
**ブランチ**: `feature/voice-automation`

---

## アーキテクチャ

```
ユーザー「ノートを見せて」
  → マイク → OpenAI Realtime API
  → AIがfunction_callを判定: navigate_to_screen({screen: "note"})
  → useConversation.handleFunctionCall
  → dispatchVoiceAction → VoiceActionContext経由でApp.tsxのコールバック実行
  → setScreen("note") → 画面遷移
  → 結果をAIに返却 → AI「ノートの画面に移動しました」と読み上げ
```

### 主要コンポーネント

| ファイル | 役割 |
|---------|------|
| `contexts/VoiceActionContext.tsx` | アクションコールバックのRefを保持するContext |
| `hooks/useConversation.ts` | OpenAI接続・function call処理（AppContentレベルで呼び出し） |
| `App.tsx` | コールバックの実装を登録、確認ダイアログ管理 |
| `lib/constants.ts` | REALTIME_TOOLS定義（全11ツール） |
| `lib/prompt-builder.ts` | AIへの指示プロンプト（ツール使用ルール含む） |
| `components/ActiveConversationBanner.tsx` | 他画面での「会話中」バナー表示 |

### useConversationのリフトアップ

`useConversation` は `ConversationScreen` 内ではなく `AppContent` レベルで呼び出される。
これにより、会話中に他のタブに音声で移動しても **WebSocket接続と音声が途切れない**。

- 他タブ上では `ActiveConversationBanner`（「のんびりとお話し中です — タップで戻る」）が表示される
- 会話画面に戻ればそのまま会話を継続できる

---

## 安全性ティアモデル

すべての音声操作を4段階の安全レベルに分類している。

### Tier 0: 読み取り・閲覧系（自動実行、確認不要）

データ変更なし。リスクゼロ。AIが即座に実行し、結果を口頭で伝える。

| # | ツール名 | 説明 | 発話例 |
|---|---------|------|--------|
| 1 | `search_past_conversations` | 過去の会話をキーワード検索 | 「前に旅行の話したよね？」 |
| 2 | `get_note_entries` | 記録済みノート内容を取得 | 「思い出に何を記録した？」 |
| 3 | `navigate_to_screen` | 画面を切り替え | 「ノートを見せて」「設定を開いて」 |
| 4 | `view_note_category` | ノートの特定カテゴリを表示 | 「医療の記録を見せて」 |
| 5 | `filter_conversation_history` | 履歴画面を表示 | 「前の会話を見せて」 |

#### navigate_to_screen 移動先

| パラメータ値 | 移動先画面 | 日本語ラベル |
|-------------|-----------|-------------|
| `conversation` | 会話画面 | 会話 |
| `note` | エンディングノート | ノート |
| `history` | 会話履歴 | 履歴 |
| `settings` | 設定画面 | 設定 |
| `family` | 家族ダッシュボード | 家族 |

#### view_note_category カテゴリ一覧

| カテゴリID | 日本語名 |
|-----------|---------|
| `memories` | 思い出 |
| `people` | 大事な人・ペット |
| `house` | 生活 |
| `medical` | 医療・介護 |
| `funeral` | 葬儀・供養 |
| `money` | お金・資産 |
| `work` | 仕事・事業 |
| `digital` | デジタル |
| `legal` | 相続・遺言 |
| `trust` | 信託・委任 |
| `support` | 支援制度 |

#### search_past_conversations パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `query` | string | はい | 検索キーワード |
| `category` | string | いいえ | カテゴリで絞り込み |

#### filter_conversation_history パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `category` | string | いいえ | カテゴリで絞り込み |

---

### Tier 1: 可逆設定変更（自動実行、AI口頭確認）

設定変更だが簡単に元に戻せる。AIが即座に実行し、変更結果を口頭で確認する。

| # | ツール名 | 説明 | 発話例 | AIの応答例 |
|---|---------|------|--------|-----------|
| 6 | `change_font_size` | 文字サイズ変更 | 「文字を大きくして」 | 「文字を大きめに変更しました、見やすくなりましたか？」 |
| 7 | `change_character` | キャラクター変更 | 「話し相手を変えたい」 | 「次回の会話からのんびりがお相手します」 |
| 8 | `update_user_name` | 表示名変更 | 「太郎と呼んで」 | 「お名前を太郎に変更しました」 |

#### change_font_size パラメータ

| パラメータ | 型 | 必須 | 値 | 日本語ラベル |
|-----------|------|------|-----|-------------|
| `level` | string | はい | `standard` | 標準 |
| | | | `large` | 大きめ |
| | | | `x-large` | 特大 |

#### change_character パラメータ

| パラメータ | 型 | 必須 | 値 | 説明 |
|-----------|------|------|-----|------|
| `character_name` | string | はい | `のんびり` | 穏やかな話し相手（voice: shimmer） |
| | | | `しっかり` | 頼れる相談相手（voice: echo） |
| | | | `にこにこ` | 明るい話し相手（voice: nova） |

**注意**: キャラクター変更は **次回の会話から適用** される（現在の会話のAI音声は変わらない）。プロフィールに保存され、次回 `start()` 時に新キャラクターが使われる。

#### update_user_name パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `name` | string | はい | 新しい名前（空文字はエラー） |

---

### Tier 2: 重要操作（UI確認ダイアログ必須）

影響が大きい操作。AIが確認ダイアログを表示し、**タッチでの「はい」が必須**。
声での「はい」は誤発動リスクがあるため、タッチ確認を必須としている。

| # | ツール名 | 説明 | 発話例 |
|---|---------|------|--------|
| 9 | `start_focused_conversation` | テーマ指定で新しい会話開始 | 「お金のことで話したい」 |
| 10 | `create_family_invitation` | 家族招待リンク作成 | 「妻を招待して」 |

#### 確認フロー

```
ユーザー「お金のことで話したい」
  → AI: start_focused_conversation({category: "money"})
  → 確認ダイアログ表示: 「お金・資産のテーマで新しい会話を始めますか？現在の会話は保存されます。」
  → AI: 「確認画面を表示しました。よろしければ画面の『はい』を押してください」
  → ユーザーがタッチで「はい」→ 現在の会話停止 → 新しい会話開始
  → ユーザーがタッチで「キャンセル」→ 何も起こらない、会話続行
```

#### start_focused_conversation パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `category` | string | はい | 会話テーマ（view_note_categoryと同じカテゴリ一覧） |

#### create_family_invitation パラメータ

| パラメータ | 型 | 必須 | 値 | 説明 |
|-----------|------|------|-----|------|
| `relationship` | string | はい | `spouse` | 配偶者 |
| | | | `child` | 子 |
| | | | `sibling` | 兄弟姉妹 |
| | | | `grandchild` | 孫 |
| | | | `other` | その他 |
| `relationship_label` | string | はい | 任意テキスト | 表示用の関係名（例：「妻」「長男」） |

---

### Tier 3: 禁止操作（ツール化しない）

声だけでは危険すぎる操作。AIは実行せず、該当画面への移動を提案する。

| 操作 | 禁止理由 | AIの応答 |
|------|---------|---------|
| データ全削除 | 不可逆 | 「削除は設定画面から行えます。設定画面に移動しましょうか？」 |
| 会話記録・ノートの個別削除 | 不可逆 | 「削除は設定画面から行えます。設定画面に移動しましょうか？」 |
| 家族メンバー削除 | 社会的影響大 | 「家族の管理は家族画面から行えます。家族画面に移動しましょうか？」 |
| 逝去報告 | 重大すぎる | 「大切な手続きですので、家族画面から行ってください。家族画面に移動しましょうか？」 |
| 同意書提出 | 法的意味を持つ | 「同意の手続きは画面から行えます。該当画面に移動しましょうか？」 |
| データインポート | 上書きで不可逆 | 「データの管理は設定画面から行えます。設定画面に移動しましょうか？」 |
| データエクスポート | ファイル操作 | 「データの管理は設定画面から行えます。設定画面に移動しましょうか？」 |

ユーザーが画面移動に同意した場合は、`navigate_to_screen` で該当画面へ案内する。

---

### ライフサイクル操作

会話セッション自体の終了を制御するツール。

| # | ツール名 | 説明 | 発話例 |
|---|---------|------|--------|
| 11 | `end_conversation` | 会話を終了してデータを保存 | 「もう疲れた」「また今度」「今日はここまで」 |

#### end_conversation の動作

パラメータなし。AIが文脈からユーザーの終了意図を判断して呼び出す。

**重要**: 特定のキーワードではなく、ニュアンスで判断する。

```
ユーザー: 「もう疲れたから今日はここまでにしよう」
  → AI: end_conversation()
  → 結果: {success: true, message: "会話を終了します。短い別れの挨拶をしてください。"}
  → AI: 「お疲れ様でした。今日もいいお話ができましたね。またいつでもお話ししましょう。」
  → 3秒後（音声再生完了待ち）に会話を自動停止
  → データ保存・要約・WebSocket切断
```

#### 終了意図の検出例

| 発話例 | 判定 | 理由 |
|--------|------|------|
| 「もう疲れた」 | 終了 | 疲労による終了意図 |
| 「また今度ね」 | 終了 | 次回への先送り |
| 「今日はここまでにしよう」 | 終了 | 明示的な終了宣言 |
| 「ありがとう、おしまい」 | 終了 | 感謝 + 終了 |
| 「もう大丈夫です」 | 終了 | 十分という意思表示 |
| 「疲れてきたけどもう少し話したい」 | 続行 | 疲労に言及しているが続行意思あり |
| 「この話は今日はここまでにして、次の話題に」 | 続行 | 話題の切り替えであって会話終了ではない |

#### barge-in によるキャンセル

AIのお別れ音声再生中にユーザーが割り込んで話した場合、終了フローはキャンセルされ会話が続行する。
これにより「あ、もう一つだけ聞きたい」といった状況に対応できる。

---

## AIの振る舞いルール

### ツール使用の基本方針

- ツールの存在をユーザーに説明しない（「ツールで操作できます」のような案内はNG）
- ユーザーの発話意図に応じて、AIが自然に判断してツールを呼び出す
- 操作後は簡潔に結果を口頭で伝える

### 話題変更 vs テーマ切り替え

- 会話中に「お金の話がしたい」と言われた場合 → **今の会話の中で柔軟に話題を変える**（ツール不使用）
- 明示的に「新しい会話を始めたい」「テーマを変えて」と言われた場合 → `start_focused_conversation` を使用

### 操作後の口頭確認パターン

| ティア | パターン | 例 |
|--------|---------|-----|
| Tier 0 | 結果を簡潔に伝える | 「ノートの画面に移動しました」 |
| Tier 1 | 結果 + 確認の問いかけ | 「文字を大きめに変更しました、見やすくなりましたか？」 |
| Tier 2 | 確認画面の誘導 | 「確認画面を出しました。よろしければ画面の『はい』を押してください」 |
| Tier 3 | 画面への案内提案 | 「削除は設定画面から行えます。設定画面に移動しましょうか？」 |

---

## シナリオ集

### シナリオ1: 画面ナビゲーション

```
ユーザー: 「ノートを見せて」
AI: navigate_to_screen({screen: "note"})
→ 画面がノートに切り替わる
→ 会話中バナー「のんびりとお話し中です — タップで戻る」が表示
AI: 「ノートの画面に移動しました」
```

### シナリオ2: ノートカテゴリ指定

```
ユーザー: 「思い出の記録を見せて」
AI: view_note_category({category: "memories"})
→ ノート画面に移動
AI: 「ノートの画面に移動しました。思い出の記録をご覧ください」
```

### シナリオ3: 文字サイズ変更

```
ユーザー: 「文字が小さくて見えないから大きくして」
AI: change_font_size({level: "large"})
→ アプリ全体のフォントサイズが変更
AI: 「文字を大きめに変更しました、見やすくなりましたか？」
```

### シナリオ4: キャラクター変更

```
ユーザー: 「もうちょっとしっかりした人と話したい」
AI: change_character({character_name: "しっかり"})
→ プロフィールに保存（次回会話から適用）
AI: 「次回の会話からしっかりがお相手します」
```

### シナリオ5: 名前変更

```
ユーザー: 「太郎って呼んでくれる？」
AI: update_user_name({name: "太郎"})
→ プロフィールに保存
AI: 「お名前を太郎に変更しました」
```

### シナリオ6: テーマ指定会話開始（確認あり）

```
ユーザー: 「お金のことで相談したいんだけど」
AI: start_focused_conversation({category: "money"})
→ 確認ダイアログ表示: 「お金・資産のテーマで新しい会話を始めますか？」
AI: 「確認画面を出しました。よろしければ画面の『はい』を押してください」
→ ユーザーが「はい」タップ → 現在の会話終了 → お金テーマの新規会話開始
```

### シナリオ7: 家族招待（確認あり）

```
ユーザー: 「妻を招待したい」
AI: create_family_invitation({relationship: "spouse", relationship_label: "妻"})
→ 確認ダイアログ表示: 「妻として家族を招待しますか？」
AI: 「確認画面を出しました。よろしければ画面の『はい』を押してください」
→ ユーザーが「はい」タップ → 招待リンク作成 → 家族ダッシュボードに移動
```

### シナリオ8: 禁止操作（画面案内）

```
ユーザー: 「全部消して」
AI: （ツール呼び出しなし）
AI: 「削除は大事な操作ですので、設定画面から行えます。設定画面に移動しましょうか？」
ユーザー: 「うん」
AI: navigate_to_screen({screen: "settings"})
AI: 「設定画面に移動しました」
```

### シナリオ9: 過去会話検索

```
ユーザー: 「前に旅行の話したよね？何て言ったか覚えてる？」
AI: search_past_conversations({query: "旅行"})
→ 過去の会話記録から旅行に関する内容を取得
AI: 「以前の会話で、北海道に旅行に行った思い出をお話しされていましたね。…」
```

### シナリオ10: 会話終了（意図検出）

```
ユーザー: 「もう疲れちゃったから、また今度にしようかな」
AI: end_conversation()
→ 結果: {success: true, message: "..."}
AI: 「今日もたくさんお話しできてよかったです。ゆっくりお休みくださいね。」
→ 3秒後に会話自動停止、データ保存・要約開始
```

### シナリオ11: 話題変更（ツール不使用）

```
ユーザー: （医療テーマの会話中に）「お金のことも気になるんだけど」
AI: （ツール呼び出しなし — 会話内で対応）
AI: 「お金のことも気になりますよね。どんなことが心配ですか？」
```

---

## 技術的な制約・注意事項

### エラーハンドリング

- すべてのツール呼び出しは try/catch で囲まれている
- 同期ツール（Tier 0, Tier 1のchangeFontSize）はエラー時に `{error: "..."}`を返却
- 非同期ツール（changeCharacter, updateUserName）はPromise.catchで `{error: "操作中にエラーが発生しました"}` を返却
- エラー時のメッセージはすべて日本語

### 画面ナビゲーション中のまとめ作成ガード

会話終了後のサマリー作成中（`isSummarizing === true`）に画面移動しようとすると、ConfirmDialogで確認が入る。
音声操作の `navigateWithGuard` も同じガードを通るため、まとめ中は移動前に確認ダイアログが表示される。

### セッション制限

- 1日最大5回の会話セッション
- 1セッション最大20分
- これらはサーバー側で強制（クライアント側はUX表示のみ）
- オンボーディング会話はセッション上限にカウントされない（下記参照）

### セキュリティ

- パスワード・暗証番号・カード番号・口座番号はAIが絶対に聞かない（プロンプトで制約）
- 機密情報を言いそうになったらAIがやんわり止める
- 全ツール呼び出しの結果は OpenAI に JSON で返却されるが、機密情報は含まれない

## オンボーディング会話フロー

新規ユーザー（`profile.name === ""`）に対して、フォーム入力ではなく音声会話でセットアップを行う。

### 使用ツール

| ツール | 用途 | Tier |
|--------|------|------|
| `update_user_name` | ユーザー名の設定 | Tier 1 |
| `change_character` | キャラクター選択 | Tier 1 |
| `change_font_size` | 文字サイズ選択 | Tier 1 |
| `end_conversation` | 全設定完了後の会話終了 | Lifecycle |

### フロー

1. のんびり（character-a, voice: shimmer）がデフォルトキャラクターとして自己紹介
2. お名前を聞いて `update_user_name` で設定
3. 3キャラクター（のんびり/しっかり/にこにこ）を紹介し選択 → `change_character` で設定
4. 文字サイズの好み（標準/大きめ/特大）を確認 → `change_font_size` で設定
5. `end_conversation` で会話終了 → メインアプリへ遷移

### セッション制限免除

- オンボーディング会話はデイリーセッション上限にカウントされない
- WebSocket接続時に `onboarding=true` クエリパラメータを付与
- サーバー側でユーザーの `name === ""` を検証し、正規のオンボーディングのみ免除

### 関連ファイル

- `client/src/hooks/useOnboardingConversation.ts` — オンボーディング専用会話フック
- `client/src/components/OnboardingConversation.tsx` — オンボーディングUI
- `client/src/lib/prompt-builder.ts` — `buildOnboardingPrompt()` 関数
- `client/src/lib/constants.ts` — `ONBOARDING_TOOLS`, `ONBOARDING_CONVERSATION_MESSAGES`
- `server/src/routes/ws.ts` — オンボーディング接続のセッション制限免除
